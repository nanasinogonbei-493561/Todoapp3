# セキュリティ設定ガイド

## 環境変数管理

### 重要な環境変数

#### データベース関連
- `MYSQL_URL`: データベース接続URL
- `MYSQL_USERNAME`: データベースユーザー名
- `MYSQL_PASSWORD`: データベースパスワード（最重要）

#### アプリケーション設定
- `SERVER_PORT`: サーバーポート
- `SESSION_TIMEOUT`: セッションタイムアウト
- `APP_ENVIRONMENT`: 環境名（production/staging/development）

#### セキュリティ設定
- `COOKIE_SECURE`: セキュアクッキー設定
- `COOKIE_HTTP_ONLY`: HTTPOnlyクッキー設定
- `COOKIE_SAME_SITE`: SameSiteクッキー設定

### 環境変数の安全な管理

#### 1. 環境変数ファイルの作成
```bash
# テンプレートから作成
cp env.example .env.prod

# パスワード等を安全な値に変更
nano .env.prod
```

#### 2. パスワードの要件
- 最低12文字以上
- 大文字、小文字、数字、記号を含む
- 辞書に載っている単語は使用しない
- 定期的に変更する

#### 3. ファイル権限の設定
```bash
# 環境変数ファイルの権限を制限
chmod 600 .env.prod

# ログファイルの権限を制限
chmod 640 logs/*.json
```

### セキュリティチェックリスト

#### 開発環境
- [ ] 環境変数ファイルが.gitignoreに含まれている
- [ ] パスワードが平文でコードに含まれていない
- [ ] デバッグログが有効になっている
- [ ] H2コンソールが有効になっている（開発時のみ）

#### 本番環境
- [ ] 環境変数ファイルが.gitignoreに含まれている
- [ ] パスワードが強固な値に設定されている
- [ ] デバッグログが無効になっている
- [ ] H2コンソールが無効になっている
- [ ] エラーメッセージの詳細表示が無効になっている
- [ ] SSL/TLSが有効になっている
- [ ] セキュアクッキーが設定されている

### 環境変数の検証

#### 自動検証スクリプト
```bash
# 環境変数の設定を確認
./scripts/setup-env.sh prod

# 必須環境変数が不足している場合はエラーが表示される
```

#### 手動検証
```bash
# 環境変数が正しく設定されているか確認
echo $MYSQL_PASSWORD

# パスワードが空でないことを確認
if [ -z "$MYSQL_PASSWORD" ]; then
    echo "ERROR: MYSQL_PASSWORD is not set"
    exit 1
fi
```

### トラブルシューティング

#### よくある問題

1. **環境変数が読み込まれない**
   ```bash
   # 環境変数ファイルの構文を確認
   cat .env.prod | grep -v "^#" | grep -v "^$"
   
   # 環境変数が設定されているか確認
   env | grep MYSQL
   ```

2. **パスワードが漏洩している**
   ```bash
   # コード内でパスワードを検索
   grep -r "password" src/ --exclude-dir=target
   
   # ログファイルでパスワードを検索
   grep -r "password" logs/ --exclude-dir=target
   ```

3. **権限エラー**
   ```bash
   # ファイル権限を確認
   ls -la .env.prod
   ls -la logs/
   
   # 権限を修正
   chmod 600 .env.prod
   chmod 640 logs/*.json
   ```

### ベストプラクティス

1. **環境変数の命名規則**
   - 大文字とアンダースコアを使用
   - 意味が明確な名前を付ける
   - プレフィックスを使用してグループ化

2. **パスワード管理**
   - パスワードマネージャーを使用
   - 定期的にパスワードを変更
   - 環境ごとに異なるパスワードを使用

3. **ログ管理**
   - 機密情報をログに出力しない
   - ログファイルの権限を制限
   - 定期的にログをローテーション

4. **アクセス制御**
   - 必要最小限の権限を付与
   - 定期的にアクセス権限をレビュー
   - 不要なアクセスを削除

### 緊急時の対応

#### パスワード漏洩が疑われる場合
1. 即座にパスワードを変更
2. ログファイルを確認
3. 不正アクセスの有無を確認
4. セキュリティチームに報告

#### 環境変数ファイルが漏洩した場合
1. 即座にすべてのパスワードを変更
2. 環境変数ファイルを再作成
3. アクセスログを確認
4. セキュリティチームに報告 